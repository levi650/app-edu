{% extends 'base.html' %}

{% block title %}{{ prospect.name }} - Prospect Details{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Prospect Header -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="card-title">{{ prospect.name }}</h2>
                            <p class="text-muted">
                                <i class="bi bi-geo-alt"></i> {{ prospect.get_country_display }}
                                {% if prospect.city %} | {{ prospect.city }}{% endif %}
                            </p>
                        </div>
                        <div class="text-end">
                            <span id="prospect-score-badge" class="badge bg-primary fs-6">Score: <span id="prospect-score-value">{{ prospect.score }}</span>/100</span>
                            <br>
                            <span class="badge bg-{% if prospect.priority == 'H' %}danger{% elif prospect.priority == 'M' %}warning{% else %}secondary{% endif %} mt-2">
                                {{ prospect.get_priority_display }}
                            </span>
                            <br>
                            <span class="badge bg-info mt-2">{{ prospect.get_stage_display }}</span>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">Contact Information</h6>
                            <p>
                                <strong>Name:</strong> {{ prospect.contact_name }}<br>
                                <strong>Role:</strong> {{ prospect.contact_role }}<br>
                                <strong>Email:</strong> 
                                <a href="mailto:{{ prospect.email }}">{{ prospect.email }}</a><br>
                                <strong>Phone:</strong> 
                                {% if prospect.phone %}
                                    <a href="tel:{{ prospect.phone }}">{{ prospect.phone }}</a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Organization Details</h6>
                            <p>
                                <strong>Type:</strong> {{ prospect.get_type_of_establishment_display }}<br>
                                <strong>Website:</strong> 
                                {% if prospect.website %}
                                    <a href="{{ prospect.website }}" target="_blank">Visit</a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}<br>
                                <strong>LinkedIn:</strong>
                                {% if prospect.linkedin_url %}
                                    <a href="{{ prospect.linkedin_url }}" target="_blank">Profile</a>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}<br>
                                <strong>Budget:</strong> 
                                {% if prospect.budget %}
                                    ${{ prospect.budget|floatformat:0 }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Notes -->
                    {% if prospect.notes %}
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="text-muted">Notes</h6>
                        <p class="mb-0">{{ prospect.notes }}</p>
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="mt-4">
                        <a href="{% url 'crm:prospect_update' prospect.pk %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-pencil"></i> Edit Prospect
                        </a>
                        <a href="{% url 'crm:prospect_delete' prospect.pk %}" class="btn btn-sm btn-danger" 
                           onclick="return confirm('Are you sure?');">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                        <a href="{% url 'crm:prospect_list' %}" class="btn btn-sm btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back
                        </a>
                    </div>
                </div>
            </div>

            <!-- Recent Interactions -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Interaction History</h5>
                    <a href="{% url 'crm:interaction_create' prospect.pk %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> New Interaction
                    </a>
                </div>
                <div class="card-body">
                    {% if prospect.interactions.all %}
                        <div class="timeline">
                            {% for interaction in prospect.interactions.all|dictsort:"-created_at" %}
                            <div class="timeline-item mb-3 pb-3 border-bottom">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="mb-1">
                                            <span class="badge bg-secondary">{{ interaction.get_interaction_type_display }}</span>
                                            {% if interaction.outcome %}
                                                <span class="badge bg-{% if interaction.outcome == 'P' %}success{% else %}danger{% endif %}">
                                                    {{ interaction.get_outcome_display }}
                                                </span>
                                            {% endif %}
                                        </h6>
                                        <p class="mb-2">{{ interaction.summary }}</p>
                                        <small class="text-muted">
                                            By {{ interaction.created_by.get_full_name|default:interaction.created_by.email }}
                                            on {{ interaction.created_at|date:"d/m/Y H:i" }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">No interactions yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Score Breakdown -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Score Breakdown</h5>
                </div>
                <div class="card-body">
                    <div id="score-breakdown" class="score-breakdown">
                        {% for component, details in score_breakdown.items %}
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between">
                                <strong>{{ details.label }}</strong>
                                <span class="badge {% if details.points > 0 %}bg-success{% elif details.points < 0 %}bg-danger{% else %}bg-secondary{% endif %}">
                                    {% if details.points > 0 %}+{% endif %}{{ details.points }}
                                </span>
                            </div>
                            <small class="text-muted d-block mt-1">{{ details.reason }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex justify-content-between">
                            <strong>Total Score</strong>
                            <strong id="total-score">{{ prospect.score }}/100</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Key Information</h5>
                </div>
                <div class="card-body">
                    <p>
                        <strong>Owner:</strong><br>
                        {{ prospect.owner.get_full_name|default:prospect.owner.email }}
                    </p>
                    <p>
                        <strong>Created:</strong><br>
                        <span id="prospect-created">{{ prospect.created_at|date:"d/m/Y H:i" }}</span>
                    </p>
                    <p>
                        <strong>Last Updated:</strong><br>
                        <span id="prospect-updated">{{ prospect.updated_at|date:"d/m/Y H:i" }}</span>
                    </p>
                    {% if prospect.last_interaction_at %}
                    <p>
                        <strong>Last Interaction:</strong><br>
                        <span id="prospect-last-interaction">{{ prospect.last_interaction_at|date:"d/m/Y H:i" }}</span>
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <a href="{% url 'crm:interaction_create' prospect.pk %}" class="btn btn-sm btn-outline-primary w-100 mb-2">
                        <i class="bi bi-chat"></i> Log Interaction
                    </a>
                    <a href="{% url 'emails:enrollment_create' %}?prospect_id={{ prospect.pk }}" class="btn btn-sm btn-outline-success w-100 mb-2">
                        <i class="bi bi-envelope"></i> Enroll in Sequence
                    </a>
                    <button onclick="updateStage({{ prospect.pk }})" class="btn btn-sm btn-outline-info w-100">
                        <i class="bi bi-arrow-right"></i> Update Stage
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateStage(prospectId) {
    const stage = prompt('Enter new stage (0=New, 1=Contacted, 2=Engaged, 3=Interested, 4=Demo Scheduled, 5=Demo Done, 6=Converted, 7=Lost):');
    if (stage !== null) {
        const stageMap = {
            '0': 'new',
            '1': 'contacted',
            '2': 'engaged',
            '3': 'interested',
            '4': 'demo_scheduled',
            '5': 'demo_done',
            '6': 'converted',
            '7': 'lost'
        };
        if (stageMap[stage]) {
            window.location.href = `{% url 'crm:prospect_update' prospect.pk %}?stage=${stageMap[stage]}`;
        }
    }
}
</script>
<script>
// Poll prospect summary endpoint and update parts of the page every 15s
(function(){
    const endpoint = "{% url 'crm:api_prospect_summary' prospect.pk %}";
    async function refreshSummary(){
        try{
            const res = await fetch(endpoint, {credentials: 'same-origin'});
            if(!res.ok) return;
            const data = await res.json();

            // Update score
            if(document.getElementById('prospect-score-value')){
                document.getElementById('prospect-score-value').textContent = data.score ?? '';
            }
            if(document.getElementById('total-score')){
                document.getElementById('total-score').textContent = (data.score ?? '') + '/100';
            }

            // Update last interaction and interactions count
            if(document.getElementById('prospect-last-interaction')){
                const dt = data.last_interaction ? new Date(data.last_interaction) : null;
                document.getElementById('prospect-last-interaction').textContent = dt ? dt.toLocaleString() : '-';
            }

            // Optionally refresh score breakdown by re-requesting a small HTML fragment endpoint in future
            // For now, mark positive/negative by color based on points if breakdown is present
            if(data.interactions_count !== undefined){
                // update interactions header badge if present
                const header = document.querySelector('.card-header h5');
                if(header && header.textContent.includes('Interaction History')){
                    // append count
                    header.textContent = `Interaction History (${data.interactions_count})`;
                }
            }
        }catch(e){
            console.debug('Error refreshing prospect summary', e);
        }
    }

    // Initial load and periodic refresh
    refreshSummary();
    setInterval(refreshSummary, 15000);
})();
</script>
{% endblock %}
